<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Sign Up</title>
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src *"/> -->
    <link href=" css/signup.css" rel="stylesheet">
    <link href="css/ratchet.css" rel="stylesheet">
    <script src="js/ratchet.js" type="text/javascript"></script>
    <script src="cordova.js"></script>
    <script src="bower_components/argon2-browser/lib/argon2.js" type="text/javascript"></script>
    <script src="js/filesystem.js" type="text/javascript"></script>
    <script type="text/javascript">
    // window.onload = function() {
    //     requestPFS();
    // }
    window.onload = function() {
        document.addEventListener("deviceready", requestPFS, false);
    }
    </script>
</head>

<body>
    <header class="bar bar-nav">
        <h1 class="title"><b>Secured Health App<b></h1>
    </header>
    <div class="content" id="main">
        <p>
            <form style="margin: 10px 10px 10px 10px ;" action="javascript:submit()">
                <h3><center> Create account <center></h3>
                <input type="email" id="email" placeholder="E-mail" required>
                <input type="password" id="password" placeholder="Password" required>
                <label class="switch">
                    <input type="checkbox" onclick="showPW()">
                    <span class="slider"></span>
                </label>
                <label>Show Password</label>
                <br><br>
                <div id="message">
                    <h5>Password must contain the following:</h5>
                    <h5 id="letter" class="invalid">A <b>lowercase</b> letter</h5>
                    <h5 id="capital" class="invalid">A <b>capital (uppercase)</b> letter</h5>
                    <h5 id="number" class="invalid">A <b>number</b></h5>
                    <h5 id="special" class="invalid">A <b>Special</b> character</h5>
                    <h5 id="length" class="invalid">Minimum <b>8 characters</b></h5>
                </div>
                <button class="btn btn-positive btn-block disable" id="submitButton">Submit</button>
            </form>
        </p>
    </div>
    <script src="js/signup.js" type="text/javascript"></script>
    <script type="text/javascript">
         var userinfo, hashresult, hashresult2;

 function showPW() {
     var x = document.getElementById("password");
     if (x.type === "password") {
         x.type = "text";
     } else {
         x.type = "password";
     }
 }

 var userInput = document.getElementById("password");
 var letter = document.getElementById("letter");
 var capital = document.getElementById("capital");
 var number = document.getElementById("number");
 var length = document.getElementById("length");
 var symbol = document.getElementById("special");

 // When the user clicks on the password field, show the message box
 userInput.onfocus = function() {
     document.getElementById("message").style.display = "block";
 }

 // When the user clicks outside of the password field, hide the message box
 userInput.onblur = function() {
     document.getElementById("message").style.display = "none";
 }

 function disableSubmit() {
     document.getElementById("submitButton").classList.add("disabled");
 }

 function enableSubmit() {
     document.getElementById("submitButton").classList.remove("disabled");
 }

 userInput.onkeyup = function() {
     // Validate lowercase letters
     var lowerCaseLetters = /[a-z]/g;
     if (userInput.value.match(lowerCaseLetters)) {
         letter.classList.remove("invalid");
         letter.classList.add("valid");
         enableSubmit();
     } else {
         letter.classList.remove("valid");
         letter.classList.add("invalid");
         disableSubmit();
     }

     // Validate capital letters
     var upperCaseLetters = /[A-Z]/g;
     if (userInput.value.match(upperCaseLetters)) {
         capital.classList.remove("invalid");
         capital.classList.add("valid");
         enableSubmit();
     } else {
         capital.classList.remove("valid");
         capital.classList.add("invalid");
         disableSubmit();
     }

     // Validate numbers
     var numbers = /[0-9]/g;
     if (userInput.value.match(numbers)) {
         number.classList.remove("invalid");
         number.classList.add("valid");
         enableSubmit();
     } else {
         number.classList.remove("valid");
         number.classList.add("invalid");
         disableSubmit();
     }

     // Validate special characters
     var special = /[!@#\$%\^&\*]/g;
     if (userInput.value.match(special)) {
         symbol.classList.remove("invalid");
         symbol.classList.add("valid");
         enableSubmit();
     } else {
         symbol.classList.remove("valid");
         symbol.classList.add("invalid");
         disableSubmit();
     }
     // Validate length
     if (userInput.value.length >= 8) {
         length.classList.remove("invalid");
         length.classList.add("valid");
         enableSubmit();
     } else {
         length.classList.remove("valid");
         length.classList.add("invalid");
         disableSubmit();
     }
 }

 function afterRPFS() {
     requestTFS();
 }

 function afterRTFS() {}

 function submit() {
     hash1(document.getElementById('password').value, document.getElementById('email').value);
 }

 function hash1(password, somesalt) {
     argon2.hash({ pass: password, salt: somesalt })
         .then(h => {
             hashresult = h.hashHex;
             saveTemporaryFile("session", hashresult);
         })
         .catch(e => console.error(e.message, e.code))
 }

 function hash2(password, somesalt) {
     argon2.hash({ pass: password, salt: somesalt })
         .then(h => {
             hashresult2 = h.hashHex;
             userinfo = '{ "email":"' + somesalt + '" , "password":"' + hashresult2 + '"}';
             savePersistentFile("userinfo", userinfo);
         })
         .catch(e => console.error(e.message, e.code))
 }

 function saveTemporaryFileSuccess() {
     hash2(hashresult, document.getElementById('email').value);
 }

 function savePersistentFileSuccess() {
     hashresult,
     hashresult2,
     userinfo,
     password,
     somesalt = null;
     location.replace("home.html");
 }
    </script>
</body>

</html>